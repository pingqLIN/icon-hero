const p={SPARK_RUNTIME_LOADED:"sparkRuntimeLoaded"},d=s=>{};class i{async getKeys(){const e=await fetch("/_spark/kv",{method:"GET"});if(!e.ok){const r=`Failed to fetch KV keys: ${e.statusText}`;return Promise.reject(new Error(r))}let t;try{t=await e.json()}catch{const n="Failed to parse KV keys response";return Promise.reject(new Error(n))}if(!Array.isArray(t)){const r="KV keys response is not an array";return Promise.reject(new Error(r))}return t}async getAll(){const e=await this.getKeys(),t={},r=await Promise.all(e.map(n=>this.getKey(n)));return e.forEach((n,o)=>{const a=r[o];a!==void 0&&(t[n]=a)}),t}async getKey(e,t){let r=`/_spark/kv/${encodeURIComponent(e)}`;t&&(r+=`?collection=${encodeURIComponent(t)}`);const n=await fetch(r,{method:"GET",headers:{"Content-Type":"text/plain"}});if(!n.ok){const a=`Failed to fetch KV key: ${n.statusText}`;return n.status===404?void 0:Promise.reject(new Error(a))}const o=await n.text();try{return JSON.parse(o)}catch{const l="Failed to parse KV key response";return Promise.reject(new Error(l))}}async getOrSetKey(e,t){const r=await this.getKey(e);if(r!==void 0)return r;const n=await fetch(`/_spark/kv/${encodeURIComponent(e)}`,{method:"POST",headers:{"Content-Type":"text/plain","X-Spark-Initial":"true"},body:JSON.stringify(t)});if(!n.ok){const o=`Failed to set default value for key: ${n.statusText}`;return Promise.reject(new Error(o))}return t}async setKey(e,t,r){let n=`/_spark/kv/${encodeURIComponent(e)}`;r&&(n+=`?collection=${encodeURIComponent(r)}`);const o=await fetch(n,{method:"POST",headers:{"Content-Type":"text/plain","X-Spark-Initial":"false"},body:JSON.stringify(t)});if(!o.ok){const a=`Failed to set key: ${o.statusText}`;return Promise.reject(new Error(a))}d({payload:{value:JSON.stringify(t)}})}async deleteKey(e,t){let r=`/_spark/kv/${encodeURIComponent(e)}`;t&&(r+=`?collection=${encodeURIComponent(t)}`),await fetch(r,{method:"DELETE"})}}const y={"ai21-jamba-instruct":"ai21-labs/ai21-jamba-instruct","cohere-command-r-plus":"cohere/cohere-command-r-plus","cohere-command-r":"cohere/cohere-command-r","gpt-4o-mini":"openai/gpt-4o-mini","gpt-4o":"openai/gpt-4o","meta-llama-3.1-405b-instruct":"meta/meta-llama-3.1-405b-instruct","meta-llama-3.1-70b-instruct":"meta/meta-llama-3.1-70b-instruct","meta-llama-3.1-8b-instruct":"meta/meta-llama-3.1-8b-instruct","meta-llama-3-70b-instruct":"meta/meta-llama-3-70b-instruct","meta-llama-3-8b-instruct":"meta/meta-llama-3-8b-instruct","mistral-large-2407":"mistral-ai/mistral-large-2407","mistral-large":"mistral-ai/mistral-large","mistral-nemo":"mistral-ai/mistral-nemo","mistral-small":"mistral-ai/mistral-small","phi-3-medium-128K-instruct":"microsoft/phi-3-medium-128K-instruct","phi-3-medium-4K-instruct":"microsoft/phi-3-medium-4K-instruct","phi-3-mini-128K-instruct":"microsoft/phi-3-mini-128K-instruct","phi-3-mini-4K-instruct":"microsoft/phi-3-mini-4K-instruct","phi-3-small-128K-instruct":"microsoft/phi-3-small-128K-instruct","phi-3-small-8K-instruct":"microsoft/phi-3-small-8K-instruct"},h=s=>s?y[s]||s:"openai/gpt-4o";async function f(s,e,t){const r=h(e),a=await fetch("/_spark/llm",{method:"POST",body:JSON.stringify({messages:[{role:"system",content:"You are a helpful assistant."},{role:"user",content:s}],temperature:1,top_p:1,max_tokens:1e3,model:r,response_format:{type:t?"json_object":"text"}}),headers:{"Content-Type":"application/json"}});if(!a.ok){const u=await a.text();throw new Error(`LLM request failed: ${a.status} ${a.statusText} - ${u}`)}return(await a.json()).choices[0].message.content}function w(s,...e){return s.reduce((t,r,n)=>t+r+(e[n]||""),"")}let c=null;async function g(){try{return c||(c=await(await fetch("/_spark/user")).json(),c)}catch(s){return console.error("Failed to fetch user data:",s),null}}const m={url:window?.location?.href,load_ms:window?.performance?.now()};window.parent.postMessage({type:p.SPARK_RUNTIME_LOADED,payload:m},"*");fetch("/_spark/loaded",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(m)});const k={keys:async()=>new i().getKeys(),get:async s=>new i().getKey(s),set:async(s,e)=>new i().setKey(s,e),delete:async s=>new i().deleteKey(s)};window.spark={llmPrompt:w,llm:f,user:g,kv:k};
